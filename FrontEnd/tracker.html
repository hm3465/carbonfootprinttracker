<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Track My Footprint</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<header>
  <div class="nav-container">
    <h1 class="logo">Carbon Footprint Tracker</h1>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="why.html">Why</a></li>
        <li><a href="how.html">How</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <div class="quiz-container" style="max-width: 900px;">
    <h2 style="margin-bottom:1rem;">Daily Inputs</h2>

    <!-- TRAVEL -->
    <section>
      <h3 style="margin:.5rem 0 1rem;">Travel (add trips)</h3>
      <div id="tripList"></div>
      <button id="addTripBtn" class="btn" type="button" style="margin-top:.75rem;">+ Add Trip</button>
      <p class="hint" style="margin-top:.5rem;">
        Add each trip you made today and its distance in kilometers.
      </p>
    </section>

    <!-- ELECTRICITY -->
    <section style="margin-top:2rem;">
      <h3 style="margin:.5rem 0 1rem;">Electricity</h3>
      <div class="form-group">
        <label for="kwh">kWh used today</label>
        <input id="kwh" type="number" min="0" step="0.1" placeholder="e.g., 18"/>
      </div>
      <div class="form-group">
        <label for="gridZone">Country code (for grid mix)</label>
        <input id="gridZone" type="text" maxlength="2" placeholder="e.g., us"/>
        <p class="hint">Type your 2-letter country code (e.g., us, in, de, gb, cn).</p>
      </div>
    </section>

    <!-- EXPENSES -->
    <section style="margin-top:2rem;">
      <h3 style="margin:.5rem 0 1rem;">Expenses (add purchases)</h3>
      <div id="expenseList"></div>
      <button id="addExpenseBtn" class="btn" type="button" style="margin-top:.75rem;">+ Add Expense</button>
      <p class="hint" style="margin-top:.5rem;">
        Simple spend-based estimate (kg COâ‚‚e per $) by category.
      </p>
    </section>

    <div class="quiz-actions" style="justify-content:flex-end; margin-top:2rem;">
      <button id="calcBtn" class="btn" type="button">Calculate Footprint</button>
    </div>
  </div>
</main>

<footer>
  <p>Hackathon 2025</p>
</footer>

<script>
(function () {
  const API_BASE = "http://localhost:3000";
  const $ = (id) => document.getElementById(id);
  const numberOrZero = (v) => { const n = Number(v); return isFinite(n) && n > 0 ? n : 0; };

  // Fallback factors if API fails
  const LOCAL_TRAVEL_FACTORS_KG_PER_KM = { air: 0.15, rail: 0.041, car: 0.21 };
  const EXPENSE_FACTORS_KG_PER_USD = { groceries: 0.06, apparel: 0.09, electronics: 0.16, dining: 0.10, other: 0.07 };

  /* ---------- Row Templates ---------- */
  function tripRowTemplate(i) {
    return `
      <div class="trip-row" data-idx="${i}">
        <select class="trip-mode">
          <option value="car">Car</option>
          <option value="air">Air</option>
          <option value="rail">Rail</option>
        </select>
        <input class="trip-dist" type="number" min="0" step="0.1" placeholder="Distance (km)" />
        <button class="link-reset remove-trip" type="button">Remove</button>
      </div>
    `;
  }

  /* Expense row now has 4 separate columns: desc | category | amount | remove */
  function expenseRowTemplate(i) {
    return `
      <div class="expense-row" data-idx="${i}">
        <input class="expense-desc" type="text" placeholder="Description (optional)"/>
        <select class="expense-cat">
          <option value="groceries">Groceries</option>
          <option value="apparel">Apparel</option>
          <option value="electronics">Electronics</option>
          <option value="dining">Dining</option>
          <option value="other">Other</option>
        </select>
        <input class="expense-amt" type="number" min="0" step="0.01" placeholder="$ amount"/>
        <button class="link-reset remove-expense" type="button">Remove</button>
      </div>
    `;
  }

  async function postJSON(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  document.addEventListener("DOMContentLoaded", () => {
    const tripList = $("tripList");
    const expenseList = $("expenseList");

    // Seed default rows
    tripList.insertAdjacentHTML("beforeend", tripRowTemplate(0));
    expenseList.insertAdjacentHTML("beforeend", expenseRowTemplate(0));

    // Add buttons
    $("addTripBtn").addEventListener("click", () => {
      const i = tripList.querySelectorAll(".trip-row").length;
      tripList.insertAdjacentHTML("beforeend", tripRowTemplate(i));
    });
    $("addExpenseBtn").addEventListener("click", () => {
      const i = expenseList.querySelectorAll(".expense-row").length;
      expenseList.insertAdjacentHTML("beforeend", expenseRowTemplate(i));
    });

    // Remove buttons (delegated)
    tripList.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-trip")) e.target.closest(".trip-row")?.remove();
    });
    expenseList.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-expense")) e.target.closest(".expense-row")?.remove();
    });

    // Calculate
    $("calcBtn").addEventListener("click", async () => {
      const tripRows = [...document.querySelectorAll(".trip-row")];
      const expenseRows = [...document.querySelectorAll(".expense-row")];

      const kwh = numberOrZero($("kwh").value);
      const gridCountry = $("gridZone").value.trim().toLowerCase() || "us";

      let travelKg = 0, elecKg = 0, expKg = 0;
      const tripsSnapshot = [], expensesSnapshot = [];

      try {
        const ping = await fetch(`${API_BASE}/health`).then(r => r.ok ? r.json() : null).catch(() => null);
        if (!ping) { alert("Cannot reach server at " + API_BASE); return; }

        // Travel
        for (const row of tripRows) {
          const mode = row.querySelector(".trip-mode").value;
          const distKm = numberOrZero(row.querySelector(".trip-dist").value);
          if (distKm <= 0) continue;
          let kg = 0;
          try {
            const j = await postJSON(`${API_BASE}/api/vehicle`, {
              distance_value: distKm,
              distance_unit: "km",
              mode
            });
            kg = Number(j?.data?.attributes?.carbon_kg) || 0;
          } catch {
            kg = distKm * (LOCAL_TRAVEL_FACTORS_KG_PER_KM[mode] || 0.1);
          }
          travelKg += kg;
          tripsSnapshot.push({ mode, distKm, kg: +kg.toFixed(3) });
        }

        // Electricity
        if (kwh > 0) {
          try {
            const j = await postJSON(`${API_BASE}/api/electricity`, {
              electricity_value: kwh,
              electricity_unit: "kwh",
              country: gridCountry
            });
            elecKg = Number(j?.data?.attributes?.carbon_kg) || 0;
          } catch {
            elecKg = kwh * 0.45; // fallback approx
          }
        }

        // Expenses
        for (const row of expenseRows) {
          const cat = row.querySelector(".expense-cat").value;
          const desc = row.querySelector(".expense-desc").value.trim();
          const amt = numberOrZero(row.querySelector(".expense-amt").value);
          if (amt <= 0) continue;
          const perDollar = ({"groceries":0.06,"apparel":0.09,"electronics":0.16,"dining":0.10,"other":0.07})[cat] ?? 0.07;
          const kg = amt * perDollar;
          expKg += kg;
          expensesSnapshot.push({ cat, desc, amt, kg: +kg.toFixed(3) });
        }

        const totalKg = travelKg + elecKg + expKg;

        // Persist to summary and navigate
        const summary = {
          totals: {
            travelKg: +travelKg.toFixed(3),
            elecKg: +elecKg.toFixed(3),
            expKg: +expKg.toFixed(3),
            totalKg: +totalKg.toFixed(3)
          },
          details: {
            trips: tripsSnapshot,
            electricity: { kwh, gridCountry },
            expenses: expensesSnapshot
          },
          ts: Date.now()
        };
        sessionStorage.setItem("footprintResult", JSON.stringify(summary));
        window.location.href = "summary.html";

      } catch (err) {
        console.error(err);
        alert("Error calculating footprint: " + err.message);
      }
    });
  });
})();
</script>
</body>
</html>
